stages:
  - name: Publish image
    steps:
      - publishImageConfig:
          dockerfilePath: ./Dockerfile
          buildContext: .
          tag: caesarteam/caesar-server:${CICD_GIT_BRANCH}
          pushRemote: true
          registry: index.docker.io
        when:
          branch:
            include:
              - develop
              - hotfix/*
      - publishImageConfig:
          dockerfilePath: ./Dockerfile
          buildContext: .
          tag: caesarteam/caesar-server:${CICD_GIT_TAG}
          pushRemote: true
          registry: index.docker.io
        when:
          event:
            include:
              - tag
  - name: Deploy
    steps:
      - applyYamlConfig:
          path: ./k8s/deployment.yaml
        when:
          branch:
            include:
              - develop
              - hotfix/*
  - name: Object update CronJob
    steps:
      - applyYamlConfig:
          path: ./k8s/cronjob.yaml
        when:
          branch:
            include:
              - develop
              - hotfix/*
notification:
  recipients:
    - recipient: '#pipeline'
      notifier: c-qzkvv:n-qqrqq
  condition:
    - Success
    - Changed
    - Failed
